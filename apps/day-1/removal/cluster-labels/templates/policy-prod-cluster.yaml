{{- range $clusterKey, $clusterValue := .Values.clusterlabels.clusters }}
  {{ $policyName := printf "policy-%s-cluster-claims-" $clusterKey }}
  {{ $configPolicyName := printf "cluster-claims-" $clusterKey }}
  {{ $placementName := printf "placement-%s" $policyName }}
  apiVersion: policy.open-cluster-management.io/v1
  kind: Policy
  metadata:
    name: {{ $policyName }}
    namespace: open-cluster-policies
    annotations:
      policy.open-cluster-management.io/categories: CM Configuration Management
      policy.open-cluster-management.io/controls: CM-2 Baseline Configuration
      policy.open-cluster-management.io/standards: NIST SP 800-53
  spec:
    disabled: false
    remediationAction: enforce
    policy-templates:
      - objectDefinition:
          apiVersion: policy.open-cluster-management.io/v1
          kind: ConfigurationPolicy
          metadata:
            name: {{ $configPolicyName }}
          spec:
            object-templates-raw: |
              {{- range $index, $item := $clusterValue.clusterclaims }}
              - complianceType: musthave
                objectDefinition:
                  apiVersion: cluster.open-cluster-management.io/v1alpha1
                  kind: ClusterClaim
                  metadata:
                    name: {{ $item.name }}
                pruneObjectBehavior: None
                remediationAction: enforce
                severity: high
              {{- end }}
  ---
  apiVersion: cluster.open-cluster-management.io/v1beta1
  kind: Placement
  metadata:
    name: {{ $placementName }}
    namespace: open-cluster-policies
  spec:
    clusterSets:
    {{- range .Values.clusterlabels.clusterSets }}
      - {{ . }}
    {{- end }}
    predicates:
      - requiredClusterSelector:
          labelSelector:
            matchExpression:
            {{- range $key, $value := .Values.clusterlabels.clusters }}
              - key: $key
                operator: Exists
            {{- end }}
    tolerations:
      - key: cluster.open-cluster-management.io/unreachable
        operator: Exists
      - key: cluster.open-cluster-management.io/unavailable
        operator: Exists
  ---
  apiVersion: policy.open-cluster-management.io/v1
  kind: PlacementBinding
  metadata:
    name: {{ $placementName}}
    namespace: open-cluster-policies
  placementRef:
    name: {{ $placementName}}
    apiGroup: cluster.open-cluster-management.io
    kind: Placement
  subjects:
    - name: {{ $policyName }}
      apiGroup: policy.open-cluster-management.io
      kind: Policy
  ---
{{ end }}